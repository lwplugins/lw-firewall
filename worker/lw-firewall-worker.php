<?php
/**
 * LW Firewall — MU-Plugin Worker
 *
 * This file is automatically installed to mu-plugins/ by the LW Firewall plugin.
 * It runs early (before template_redirect) to block bots and rate-limit requests.
 *
 * DO NOT EDIT THIS FILE DIRECTLY — it will be overwritten on plugin activation.
 *
 * @package LightweightPlugins\Firewall
 * @version 1.1.0
 */

declare(strict_types=1);

if ( ! defined( 'ABSPATH' ) ) {
	exit;
}

define( 'LW_FIREWALL_WORKER_VERSION', '1.1.0' );

( static function (): void {
	$plugin_path = WP_PLUGIN_DIR . '/lw-firewall/';
	$autoload    = $plugin_path . 'includes/';

	if ( ! file_exists( $autoload . 'Options.php' ) ) {
		return;
	}

	// Register autoloader.
	spl_autoload_register(
		static function ( string $class_name ) use ( $autoload ): void {
			$prefix = 'LightweightPlugins\\Firewall\\';

			if ( ! str_starts_with( $class_name, $prefix ) ) {
				return;
			}

			$relative = substr( $class_name, strlen( $prefix ) );
			$file     = $autoload . str_replace( '\\', '/', $relative ) . '.php';

			if ( file_exists( $file ) ) {
				require_once $file;
			}
		}
	);

	// Include shared helper if not already loaded.
	if ( ! function_exists( 'lw_firewall_resolve_storage' ) ) {
		$main_file = $plugin_path . 'lw-firewall.php';
		if ( file_exists( $main_file ) ) {
			require_once $main_file;
		}
	}

	add_action(
		'muplugins_loaded',
		static function (): void {
			$options = \LightweightPlugins\Firewall\Options::get_all();

			if ( empty( $options['enabled'] ) ) {
				return;
			}

			$ip = \LightweightPlugins\Firewall\IpDetector::get_ip();

			// --- IP Whitelist: skip all checks ---
			$whitelist = (array) ( $options['ip_whitelist'] ?? [] );

			if ( ! empty( $whitelist ) && \LightweightPlugins\Firewall\Rules\IpMatcher::matches( $ip, $whitelist ) ) {
				return;
			}

			// --- IP Blacklist: block immediately ---
			$blacklist = (array) ( $options['ip_blacklist'] ?? [] );

			if ( ! empty( $blacklist ) && \LightweightPlugins\Firewall\Rules\IpMatcher::matches( $ip, $blacklist ) ) {
				lw_firewall_log( $options, $ip, 'ip_blacklisted' );
				lw_firewall_block_403();
			}

			$storage = lw_firewall_resolve_storage( $options['storage'] ?? 'auto' );

			// --- Auto-ban check ---
			if ( ! empty( $options['auto_ban_enabled'] ) ) {
				$banner = new \LightweightPlugins\Firewall\Rules\AutoBanner( $storage );

				if ( $banner->is_banned( $ip ) ) {
					lw_firewall_log( $options, $ip, 'auto_banned' );
					\LightweightPlugins\Firewall\Rules\AutoBanner::block();
				}
			}

			// --- 404 flood check (counter is tracked in Plugin.php) ---
			if ( ! empty( $options['protect_404'] ) ) {
				$tracker = new \LightweightPlugins\Firewall\Rules\NotFoundTracker( $storage );

				if ( $tracker->is_flooding( $ip ) ) {
					lw_firewall_log( $options, $ip, 'rate_limited_404' );
					\LightweightPlugins\Firewall\Rules\RateLimiter::too_many();
				}
			}

			// --- Detect request type ---
			// phpcs:ignore WordPress.Security.ValidatedSanitizedInput
			$request_uri = $_SERVER['REQUEST_URI'] ?? '';
			$reason      = lw_firewall_detect_type( $request_uri, $options );

			if ( null === $reason ) {
				return;
			}

			// phpcs:ignore WordPress.Security.ValidatedSanitizedInput
			$user_agent = $_SERVER['HTTP_USER_AGENT'] ?? '';

			// --- Bot blocking (filter requests only) ---
			if ( 'filter' === $reason && \LightweightPlugins\Firewall\Rules\BotBlocker::is_blocked( $user_agent ) ) {
				lw_firewall_log( $options, $ip, 'bot_blocked' );
				\LightweightPlugins\Firewall\Rules\BotBlocker::block();
			}

			// --- Rate limiting ---
			$limiter = new \LightweightPlugins\Firewall\Rules\RateLimiter( $storage );

			if ( ! $limiter->is_allowed_key( $reason . '_' . $ip ) ) {
				lw_firewall_log( $options, $ip, 'rate_limited_' . $reason );

				// Record violation for auto-ban.
				if ( ! empty( $options['auto_ban_enabled'] ) ) {
					$banner = new \LightweightPlugins\Firewall\Rules\AutoBanner( $storage );
					$banner->record_violation( $ip );
				}

				// Filter uses configured action; everything else gets 429.
				if ( 'filter' === $reason ) {
					\LightweightPlugins\Firewall\Rules\RateLimiter::limit();
				} else {
					\LightweightPlugins\Firewall\Rules\RateLimiter::too_many();
				}
			}
		},
		1
	);
} )();

/**
 * Detect request type from URI.
 *
 * @param string               $uri     Request URI.
 * @param array<string, mixed> $options Plugin options.
 * @return string|null 'filter', 'cron', 'xmlrpc', 'login', 'rest', or null.
 */
function lw_firewall_detect_type( string $uri, array $options ): ?string {
	if ( str_contains( $uri, '/wp-cron.php' ) && ! empty( $options['protect_cron'] ) ) {
		return 'cron';
	}

	if ( str_contains( $uri, '/xmlrpc.php' ) && ! empty( $options['protect_xmlrpc'] ) ) {
		return 'xmlrpc';
	}

	if ( str_contains( $uri, '/wp-login.php' ) && ! empty( $options['protect_login'] ) ) {
		return 'login';
	}

	if ( str_contains( $uri, '/wp-json/' ) && ! empty( $options['protect_rest_api'] ) ) {
		return 'rest';
	}

	// WooCommerce filter parameter detection.
	// phpcs:ignore WordPress.Security.ValidatedSanitizedInput
	$query_string  = $_SERVER['QUERY_STRING'] ?? '';
	$filter_params = $options['filter_params'] ?? [ 'filter_', 'query_type_' ];

	if ( '' !== $query_string ) {
		foreach ( $filter_params as $prefix ) {
			if ( str_contains( $query_string, $prefix ) ) {
				return 'filter';
			}
		}
	}

	return null;
}

/**
 * Log a firewall event if logging is enabled.
 *
 * @param array<string, mixed> $options Plugin options.
 * @param string               $ip      Client IP.
 * @param string               $reason  Block reason.
 */
function lw_firewall_log( array $options, string $ip, string $reason ): void {
	if ( empty( $options['log_enabled'] ) ) {
		return;
	}

	\LightweightPlugins\Firewall\Logger::log(
		[
			'ip'     => $ip,
			'reason' => $reason,
			// phpcs:ignore WordPress.Security.ValidatedSanitizedInput
			'ua'     => substr( (string) ( $_SERVER['HTTP_USER_AGENT'] ?? '' ), 0, 200 ),
			// phpcs:ignore WordPress.Security.ValidatedSanitizedInput
			'url'    => sanitize_url( wp_unslash( $_SERVER['REQUEST_URI'] ?? '' ) ),
		]
	);
}

/**
 * Send 403 Forbidden and exit.
 */
function lw_firewall_block_403(): void {
	if ( ! headers_sent() ) {
		header( 'HTTP/1.1 403 Forbidden' );
		header( 'Content-Type: text/plain; charset=utf-8' );
		header( 'Cache-Control: no-store, no-cache' );
	}

	echo 'Access denied.';
	exit;
}
